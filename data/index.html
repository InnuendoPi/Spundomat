<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Spundomat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="theme.css" type="text/css">
</head>

<body onload="setInterval(refresh, 1000)">
  <div class="py-2">
    <div class="container">
      <div class="row">
        <div class="col">
          <h1 id="firmware" class="text-center"></h1>
        </div>
        <div class="col-md-auto">
          <a href="/edit" class="btn btn-outline-primary" id="btn_edit">Dateiexplorer</a>
          <button type="button" class="btn btn-outline-primary" id="btn_kalibrieren">Kalibrieren</button>
          <a href="/update" class="btn btn-outline-danger" id="btn_upd">Datei Update</a>
		      <button type="button" class="btn btn-outline-danger" id="btn_httpupdate">WebUpdate</button>
          <button type="button" class="btn btn-outline-dark" id="btn_reboot">Neustart</button>
        </div>
      </div>
    </div>
  </div>
  <div class="py-2">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">Spundomat Dashboard <a href="" class="badge badge-warning" data-target="#misc_modal"
                data-toggle="modal" data-value="-1" style="float:right">Bearbeiten</a></div>
            <div class="card-body">
              <ul class="list-group" id="miscSettings">
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="misc_modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Einstellungen</h5> <button type="button" class="close" data-dismiss="modal">
            <span>×</span></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" id="miscTab" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="misc1-tab" data-toggle="tab" href="#misc1" role="tab" aria-controls="misc1" aria-selected="true">Spundomat</a>
            </li>
			<li class="nav-item">
              <a class="nav-link" id="misc2-tab" data-toggle="tab" href="#misc2" role="tab" aria-controls="misc2" aria-selected="true">Hardware</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="misc3-tab" data-toggle="tab" href="#misc3" role="tab" aria-controls="misc3" aria-selected="true">System</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="misc4-tab" data-toggle="tab" href="#misc4" role="tab" aria-controls="misc4" aria-selected="true">Restore</a>
            </li>
          </ul>
          <div class="tab-content" id="miscTabContent">
            <div class="tab-pane fade show active" id="misc1" role="tabpanel" aria-labelledby="misc1-tab">
              <br />
              <div class="form-group">
                <label for="modal_misc_modus">Betriebsmodus</label>
                <select class="form-control" id="modal_misc_modus"></select>
              </div>
              <div class="form-group">
                <label for="modal_misc_pressure">Zielwert Druck (bar)</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_pressure" />
              </div>
              <div class="form-group">
                <label for="modal_misc_carbonation">Zielwert CO2 Gehalt (gr/l)</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_carbonation" />
              </div>
            </div>
			<div class="tab-pane fade" id="misc2" role="tabpanel" aria-labelledby="misc2-tab">
                <br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_mv1" />
                <label class="form-check-label" for="modal_misc_mv1">Aktiviere MV1 (Spunder)</label>
              </div>
			  
			  <div class="form-group">
                <label for="modal_misc_mv1open">Öffne MV1 (Spunder) in ms</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_mv1open" />
              </div>
			  <div class="form-group">
                <label for="modal_misc_mv1close">Schließe MV1 (Spunder) in ms</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_mv1close" />
              </div>
			  <br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_mv2" />
                <label class="form-check-label" for="modal_misc_mv2">Aktiviere MV2 (Karbonisieren)</label>
              </div>
			  <div class="form-group">
                <label for="modal_misc_mv2open">Öffne MV2 (Karbonisieren) in ms</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_mv2open" />
              </div>
			  <div class="form-group">
                <label for="modal_misc_mv2close">Schließe MV2 (Karbonisieren) in ms</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_mv2close" />
              </div>
			  <br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_buzzer" />
                <label class="form-check-label" for="modal_misc_buzzer">Aktiviere Buzzer</label>
              </div>
            </div>
            <div class="tab-pane fade" id="misc3" role="tabpanel" aria-labelledby="misc3-tab">
                <br />
			  <div class="form-group">
                <label for="modal_misc_intervall_pressure">Intervall lese Drucksensor in ms</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_interval_pressure" />
              </div>
			  <div class="form-group">
                <label for="modal_misc_intervall_temp">Intervall lese Temperatursensor in ms</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_interval_temp" />
              </div>
				<br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_mdns" />
                <label class="form-check-label" for="modal_misc_mdns">Aktiviere mDNS</label>
              </div>
              <div class="form-group">
                <label for="modal_misc_mdns_name">Eindeutiger mDNS Name</label>
                <input type="text" class="form-control" placeholder="" id="modal_misc_mdns_name" />
              </div>
			  <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_testmode" />
                <label class="form-check-label" for="modal_misc_testmode">Aktiviere Testmodus (debug)</label>
              </div>
              <br />
            </div>
            <div class="tab-pane fade" id="misc4" role="tabpanel" aria-labelledby="misc4-tab">
              <br />
              <label class="form-check-label">Reset Spundomat</label>
              <br />
			  <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_eeprom" />
                <label class="form-check-label" for="modal_misc_eeprom">Lösche Kalibrierung</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_reset" />
                <label class="form-check-label" for="modal_misc_reset">Lösche WiFi (Reset to AP Mode)</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_clear" />
                <label class="form-check-label" for="modal_misc_clear">Lösche alle Einstellungen (Reset to defaults)</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer"> <button type="button" class="btn btn-primary" id="modal_misc_btn_save">Speichern</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>
  
<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" id="mi-modal">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="myModalLabel">WebUpdate starten?</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			</div>
			<div class="modal-body">
				<p>BETA! Spundomat startet neu!</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" id="modal-btn-yes">Ja</button>
				<button type="button" class="btn btn-primary" id="modal-btn-no">Abbruch</button>
			</div>
		</div>
	</div>
</div>

  <script src="./jquery-3.4.1.min.js"></script>
  <script src="./bootstrap.bundle.js"></script>
  <script type="text/javascript">
  
    
	function refresh() {
      $.get("/reqMiscSet", function (data) {
        let miscRender = "<li class='list-group-item d-flex justify-content-between align-items-center'>Aktueller Betriebsmodus<span class='badge badge-info'>";
        if (data.mode == 0 )
        {
          miscRender += "Aus";  
        }
        else if (data.mode == 1)
        {
          miscRender += "Spundomat CO2";
        }
        else if (data.mode == 2)
        {
          miscRender += "Spundomat Druck";
        }
		else if (data.mode == 3)
        {
          miscRender += "Karbonisieren";
        }
		else if (data.mode == 4)
        {
          miscRender += "Kombi-Modus";
        }
        else
        {
          miscRender += "Ablaufplan";
        }

        miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert Druck<span class='badge badge-info'>";
        miscRender += data.pressure + " bar";
        miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert CO2 Gehalt<span class='badge badge-info'>";
        miscRender += data.carbonation + " g/l";
        miscRender += "</span></li> <br /> <li class='list-group-item d-flex justify-content-between align-items-center'> Aktueller CO2 Gehalt<span class='badge badge-light'>";
        miscRender += data.co2 + " g/l";

        miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'> Aktueller Druck<span class='badge badge-light'>";
        if (data.druck == -1 )
		{
			miscRender += "kein Drucksensor angeschlossen";
		}
		else
		{
			miscRender += data.druck + " bar";
		}

        miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Aktuelle Temperatur<span class='badge badge-light'>";
        if (data.temperatur == -127 )
		{
			miscRender += "kein Temperatursensor angeschlossen";
		}
		else
		{
			miscRender += data.temperatur + " °C";
		}

        miscRender += "</span></li> <br /> <li class='list-group-item d-flex justify-content-between align-items-center'>Spannung am Drucksensor<span class='badge badge-light'>";
        miscRender += data.voltage + " V";

        miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Spannung Offset <span class='badge badge-light'>";
        if (data.offset == "nan")
        {
          miscRender += "Kalibrierung ausführen!";
        }
        else {
          miscRender += data.offset + " V";
        }
		
		miscRender += "</span> </li> <br /> <li class='list-group-item d-flex justify-content-between align-items-center'> Magnetventil MV1 <span class='badge ";
        if (data.mv1) {
          miscRender += " badge-success'> An";
        }
        else {
          miscRender += " badge-dark'> Aus";
        }
		miscRender += "</span> </li> <li class='list-group-item d-flex justify-content-between align-items-center'> Magnetventil MV2 <span class='badge ";
        if (data.mv2) {
          miscRender += " badge-success'> An";
        }
        else {
          miscRender += " badge-dark'> Aus";
        }
		miscRender += "</span> </li> <li class='list-group-item d-flex justify-content-between align-items-center'> Buzzer <span class='badge ";
        if (data.buzzer) {
          miscRender += " badge-success'> An";
        }
        else {
          miscRender += " badge-dark'> Aus";
        }

        miscRender += "</span> </li> <br /> <li class='list-group-item d-flex justify-content-between align-items-center'> Aktiviere MDNS <span class='badge ";
        if (data.mdns) {
          miscRender += " badge-success'> An";
        }
        else {
          miscRender += " badge-dark'> Aus";
        }
        miscRender += " </span> </li>";
        $('#miscSettings').html(miscRender);
      });
    }
	
	var modalConfirm = function(callback){
	  
	  $("#btn_httpupdate").on("click", function(){
		$("#mi-modal").modal('show');
	  });

	  $("#modal-btn-yes").on("click", function(){
		onload = setInterval(refresh, 60000);
		callback(true);
		$("#mi-modal").modal('hide');
	  });
	  
	  $("#modal-btn-no").on("click", function(){
		callback(false);
		$("#mi-modal").modal('hide');
	  });
	};

	modalConfirm(function(confirm){
	  if(confirm){
		//Yes
		$.ajax({
        url: '/startHTTPUpdate',
        type: 'POST',
        async: false,
        cache: false
      }).done(function (msg) {
        window.location.reload(true);
      });;
	  }
	});
		
    $('#misc_modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget) // Button that triggered the modal
      var mdns;
      var mdns_name;
      var reset;
      var clear;
	  var eeprom;
      var pressure;
      var carbonation;
      var mode;
      var druck;
      var voltage;
      var temperatur;
      var co2;
      var offset;
	  var mv1;
	  var mv1open;
	  var mv1close;
	  var mv2;
	  var mv2open;
	  var mv2close;
	  var uppressure;
	  var uptemp;
	  var buzzer;
	  var testmode;

      $.ajax({
        url: '/reqMisc?req=mdns',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mdns = data;
        }
      }); 
      $.ajax({
        url: '/reqMisc?req=mdns_name',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mdns_name = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=pressure',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          pressure = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=carbonation',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          carbonation = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=mode',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mode = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=co2',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          co2 = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=voltage',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          voltage = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=temperatur',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          temperatur = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=druck',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          druck = data;
        }
      });
      $.ajax({
        url: '/reqMisc?req=offset',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          offset = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=mv1',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mv1 = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=mv1open',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mv1open = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=mv1close',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mv1close = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=mv2',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mv2 = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=mv2open',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mv2open = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=mv2close',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          mv2close = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=uppressure',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          uppressure = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=uptemp',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          uptemp = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=buzzer',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          buzzer = data;
        }
      });
	  $.ajax({
        url: '/reqMisc?req=testmode',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          testmode = data;
        }
      });

      var modal = $(this)
      $('#modal_misc_modus').load('/reqMode')
      modal.find('#modal_misc_mdns_name').val(mdns_name)
      if (mdns == "1") { modal.find('#modal_misc_mdns').prop("checked", true) }
      else { modal.find('#modal_misc_mdns').prop("checked", false) }
	  if (mv1 == "1") { modal.find('#modal_misc_mv1').prop("checked", true) }
      else { modal.find('#modal_misc_mv1').prop("checked", false) }
	  if (mv2 == "1") { modal.find('#modal_misc_mv2').prop("checked", true) }
      else { modal.find('#modal_misc_mv2').prop("checked", false) }
	  if (buzzer == "1") { modal.find('#modal_misc_buzzer').prop("checked", true) }
      else { modal.find('#modal_misc_buzzer').prop("checked", false) }
	  if (testmode == "1") { modal.find('#modal_misc_testmode').prop("checked", true) }
      else { modal.find('#modal_misc_testmode').prop("checked", false) }
      modal.find('#modal_misc_reset').prop("checked", false)
      modal.find('#modal_misc_clear').prop("checked", false)
	  modal.find('#modal_misc_eeprom').prop("checked", false)
      modal.find('#modal_misc_pressure').val(pressure)
      modal.find('#modal_misc_carbonation').val(carbonation)
	  modal.find('#modal_misc_mv1open').val(mv1open)
	  modal.find('#modal_misc_mv1close').val(mv1close)
	  modal.find('#modal_misc_mv2open').val(mv2open)
	  modal.find('#modal_misc_mv2close').val(mv2close)
	  modal.find('#modal_misc_interval_pressure').val(uppressure)
	  modal.find('#modal_misc_interval_temp').val(uptemp)
      var modal = $(this)
    });

    $("#modal_misc_btn_save").click(function () {
      var modal = $('#misc_modal')
      var mdns_name = modal.find('#modal_misc_mdns_name').val()
      var pressure = modal.find('#modal_misc_pressure').val()
      var carbonation = modal.find('#modal_misc_carbonation').val()
	  var mode = modal.find('#modal_misc_modus').val()
      var mv1open = modal.find('#modal_misc_mv1open').val()
	  var mv1close = modal.find('#modal_misc_mv1close').val()
	  var mv2open = modal.find('#modal_misc_mv2open').val()
	  var mv2close = modal.find('#modal_misc_mv2close').val()
	  var uppressure = modal.find('#modal_misc_interval_pressure').val()
	  var uptemp = modal.find('#modal_misc_interval_temp').val()
      if (modal.find('#modal_misc_mdns').prop("checked") == true)
	  {
        var mdns = "1"
      } 
	  else 
	  {
        var mdns = "0"
      }
	  if (modal.find('#modal_misc_eeprom').prop("checked") == true) 
	  {
        var eeprom = "1"
      } 
	  else 
	  {
        var eeprom = "0"
      }
      if (modal.find('#modal_misc_reset').prop("checked") == true) 
	  {
        var reset = "1"
      } 
	  else 
	  {
        var reset = "0"
      }
      if (modal.find('#modal_misc_clear').prop("checked") == true) 
	  {
        var clear = "1"
      } 
	  else 
	  {
        var clear = "0"
      }
	  if (modal.find('#modal_misc_mv1').prop("checked") == true) 
	  {
        var mv1 = "1"
      } 
	  else 
	  {
        var mv1 = "0"
      }
	  if (modal.find('#modal_misc_mv2').prop("checked") == true) 
	  {
        var mv2 = "1"
      } 
	  else 
	  {
        var mv2 = "0"
      }
	  if (modal.find('#modal_misc_buzzer').prop("checked") == true) 
	  {
        var buzzer = "1"
      } 
	  else 
	  {
        var buzzer = "0"
      }
	  if (modal.find('#modal_misc_testmode').prop("checked") == true) 
	  {
        var testmode = "1"
      } 
	  else 
	  {
        var testmode = "0"
      }

      $.ajax({
        url: '/setMisc?reset=' + reset + '&clear=' + clear + '&eeprom=' + eeprom + '&mdns=' + mdns + '&mdns_name=' + mdns_name + '&pressure=' + pressure + '&carbonation=' + carbonation + '&mode=' + mode + '&mv1=' + mv1 + '&mv1open=' + mv1open + '&mv1close=' + mv1close + '&mv2=' + mv2 + '&mv2open=' + mv2open + '&mv2close=' + mv2close + '&uppressure=' + uppressure + '&uptemp=' + uptemp + '&buzzer=' + buzzer + '&testmode=' + testmode,
        type: 'POST',
        dataType: 'html',
        async: false,
        cache: false
      });
      modal.modal('hide')
    });

    $("#btn_reboot").click(function () {
      $.ajax({
        url: '/reboot',
        type: 'POST',
        async: false,
        cache: false
      }).done(function (msg) {
        //alert("Device says: " + msg + "\n Page will be reloaded now!");
        window.location.reload(true);
      });;
    });

    $("#btn_kalibrieren").click(function () {
      $.ajax({
        url: '/kalibrieren',
        type: 'POST',
        async: false,
        cache: false
      }).done(function (msg) {
        window.location.reload(true);
      });;
    });

    $(function () {
      var firmware;
      $.ajax({
        url: '/reqMisc?req=firmware',
        type: 'get',
        dataType: 'html',
        async: false,
        cache: false,
        success: function (data) {
          firmware = data;
        }
      });
      document.getElementById("firmware").innerHTML = firmware;
    });

  </script>
</body>

</html>