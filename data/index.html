<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <title>Spundomat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache"/>
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="./bootstrap.min.css" type="text/css">
</head>

<body onload="setInterval(refresh, 2000)">
  <div class="py-2">
    <div class="container">
      <div class="row">
        <div class="col">
          <h1 id="firmware" class="text-center"></h1>
        </div>
        <div class="col-md-auto">
          <a href="/edit" class="btn btn-outline-primary" id="btn_edit">Dateiexplorer</a>
          <a href="/ablaufplan.html" class="btn btn-outline-primary">Ablaufplan</a>
          <button type="button" class="btn btn-outline-primary" id="btn_kalibrieren">Kalibrierung</button>
          <button type="button" class="btn btn-outline-primary" id="btn_visual">Visualisierung</button>
          <button type="button" class="btn btn-outline-danger" id="btn_update">Update</button>
          <button type="button" class="btn btn-outline-dark" id="btn_reboot">Neustart</button>
        </div>
      </div>
    </div>
  </div>
  <div class="py-2">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">Spundomat Dashboard <a href="" class="badge badge-primary"
                data-target="#misc_modal" data-toggle="modal" data-value="-1" style="float:right">Einstellungen</a>
            </div>
            <div class="card-body">
              <ul class="list-group" id="miscSettings"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="misc_modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Einstellungen</h5> <button type="button" class="close"
            data-dismiss="modal"><span>×</span></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" id="miscTab" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="misc1-tab" data-toggle="tab" href="#misc1" role="tab" aria-controls="misc1"
                aria-selected="true">Spundomat</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="misc2-tab" data-toggle="tab" href="#misc2" role="tab" aria-controls="misc2"
                aria-selected="true">Hardware</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="misc3-tab" data-toggle="tab" href="#misc3" role="tab" aria-controls="misc3"
                aria-selected="true">System</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="misc5-tab" data-toggle="tab" href="#misc5" role="tab" aria-controls="misc5"
                aria-selected="true">Grafana</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="misc4-tab" data-toggle="tab" href="#misc4" role="tab" aria-controls="misc4"
                aria-selected="true">Restore</a>
            </li>
          </ul>
          <div class="tab-content" id="miscTabContent">
            <div class="tab-pane fade show active" id="misc1" role="tabpanel" aria-labelledby="misc1-tab">
              <br />
              <div class="form-group row">
                <label for="modal_misc_modus" class="col-sm col-form-label">Modus</label>
                <div class="col-sm-auto">
                  <select class="form-control" id="modal_misc_modus"></select>
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_pressure" class="col-sm col-form-label">Zielwert Druck [bar]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_pressure" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_carbonation" class="col-sm col-form-label">Zielwert CO2 Gehalt [gr/l]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_carbonation" />
                </div>
              </div>
              <div class="border-top my-3"></div>
              <div class="form-group row">
                <label for="modal_misc_kombi" class="col-sm col-form-label">Verzögerung Karbonisieren im
                  Spundomat-Modus</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_kombi" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_kombi_auswahl" class="col-sm col-form-label">Einheit für Verzögerung</label>
                <div class="col-sm-auto">
                  <select class="form-control" id="modal_misc_kombi_auswahl"></select>
                </div>
              </div>
              <!-- <div class="border-top my-3"></div> -->
              <!-- <div class="form-group row">
                <label for="modal_misc_con" class="col-sm col-form-label">Zieltemperatur Gärsteuerung</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_con" />
                </div>
              </div> -->
            </div>
            <div class="tab-pane fade" id="misc2" role="tabpanel" aria-labelledby="misc2-tab">
              <br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_mv1" />
                <label class="form-check-label" for="modal_misc_mv1">Aktiviere MV1 [Spunden]</label>
              </div>
              <div class="form-group row">
                <label for="modal_misc_mv1open" class="col-sm col-form-label">Öffne MV1 [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_mv1open" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_mv1close" class="col-sm col-form-label">Schließe MV1 [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_mv1close" />
                </div>
              </div>
              <div class="border-top my-3"></div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_mv2" />
                <label class="form-check-label" for="modal_misc_mv2">Aktiviere MV2 [Karbonisieren]</label>
              </div>
              <div class="form-group row">
                <label for="modal_misc_mv2open" class="col-sm col-form-label">Öffne MV2 [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_mv2open" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_mv2close" class="col-sm col-form-label">Schließe MV2 [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_mv2close" />
                </div>
              </div>
              <div class="border-top my-3"></div>
              <div class="form-group row">
                <label for="modal_misc_modus_gpio" class="col-sm col-form-label">Modus GPIO</label>
                <div class="col-sm-auto">
                  <select class="form-control" id="modal_misc_modus_gpio"></select>
                </div>
              </div>
              <!-- <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_co2sen" />
                <label class="form-check-label" for="modal_misc_co2sen">Aktiviere CO2 Sensor</label>
              </div> -->
            </div>
            <div class="tab-pane fade" id="misc3" role="tabpanel" aria-labelledby="misc3-tab">
              <br />
              <div class="form-group row">
                <label for="modal_misc_intervall_pressure" class="col-sm col-form-label">Intervall Drucksensor
                  [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_interval_pressure" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_intervall_temp" class="col-sm col-form-label">Intervall Temperatursensor
                  [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_interval_temp" />
                </div>
              </div>
              <!-- <div class="form-group row">
                <label for="modal_misc_intervall_target" class="col-sm col-form-label">Intervall Gärsteuerung
                  [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_interval_target" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_intervall_con" class="col-sm col-form-label">Intervall Gär Controller
                  [ms]</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_interval_con" />
                </div>
              </div> -->
              <div class="border-top my-3"></div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_mdns" />
                <label class="form-check-label" for="modal_misc_mdns">Aktiviere mDNS (Neustart erforderlich)</label>
              </div>
              <div class="form-group row">
                <label for="modal_misc_mdns_name" class="col-sm col-form-label">Eindeutiger mDNS Name</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_mdns_name" />
                </div>
              </div>
              <br />
            </div>
            <div class="tab-pane fade" id="misc5" role="tabpanel" aria-labelledby="misc5-tab">
              <br />
              <label class="form-check-label">Visualisierung Spundomat Daten</label>
              <br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_db_enable" />
                <label class="form-check-label" for="modal_misc_db_enable">Aktiviere Grafana (Neustart
                  erforderlich!)</label>
              </div>
              <div class="form-group row">
                <label for="modal_misc_db_server" class="col-sm col-form-label">Datenbank Server</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="http://192.168.1.10:8086"
                    id="modal_misc_db_server" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_db_database" class="col-sm col-form-label">Datenbank Name</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="spundomat" id="modal_misc_db_database" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_db_user" class="col-sm col-form-label">Datenbank Benutzer</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_db_user" />
                </div>
              </div>
              <div class="form-group row ">
                <label for="modal_misc_db_pass" class="col-sm col-form-label">Datenbank Benutzer Password</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_db_pass" />
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_db_up" class="col-sm col-form-label">Update Intervall Datenbank in sek</label>
                <div class="col-sm-auto">
                  <input type="text" class="text-right" placeholder="" id="modal_misc_db_up" />
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="misc4" role="tabpanel" aria-labelledby="misc4-tab">
              <br />
              <div class="form-group row">
                <label for="modal_misc_rssi" class="col-sm col-form-label">WLAN Signalstärke:</label>
                <div class="col-sm">
                  <input type="text" readonly class="form-control-plaintext" id="modal_misc_rssi">
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_offset" class="col-sm col-form-label">Offset Kalibrierung bei 0bar:</label>
                <div class="col-sm">
                  <input type="text" readonly class="form-control-plaintext" id="modal_misc_offset">
                </div>
              </div>
              <div class="form-group row">
                <label for="modal_misc_offset2" class="col-sm col-form-label">Offset Kalibrierung bei 2bar:</label>
                <div class="col-sm">
                  <input type="text" readonly class="form-control-plaintext" id="modal_misc_offset2">
                </div>
              </div>
              <div class="border-top my-3"></div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_testmode" />
                <label class="form-check-label" for="modal_misc_testmode">Testmodus (nicht aktivieren!)</label>
              </div>
              <div class="border-top my-3"></div>
              <label class="form-check-label">Reset Spundomat</label>
              <br />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_eeprom" />
                <label class="form-check-label" for="modal_misc_eeprom">Lösche Kalibrierung</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_reset" />
                <label class="form-check-label" for="modal_misc_reset">Lösche WiFi (Reset to AP Mode)</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="modal_misc_clear" />
                <label class="form-check-label" for="modal_misc_clear">Lösche alle Einstellungen (Reset to
                  defaults)</label>
              </div>
              <br />
            </div>
          </div>
        </div>
        <div class="modal-footer"> <button type="button" class="btn btn-outline-success"
            id="modal_misc_btn_save">Speichern</button>
          <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true"
    id="mi-modal-upd">
    <div class="modal-dialog" data-keyboard="true">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="myModalLabelUpd">Firmware Update</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <p>Datei Upload oder Web Update?</p>
          <p>Spundomat startet automatisch neu!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-warning" id="modal-btn-file">Upload</button>
          <button type="button" class="btn btn-outline-primary" id="modal-btn-web">WebUpdate</button>
          <button type="button" class="btn btn-outline-secondary" id="modal-btn-abbruch">Zurück</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabelVis" aria-hidden="true"
    id="mi-modal-vis">
    <div class="modal-dialog" data-keyboard="true">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="myModalLabelVis">Visualisierung</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="modal_misc_vis_tag">Sud-ID für Visualisierung</label>
            <input type="text" class="form-control" placeholder="" id="modal_misc_vis_tag" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-warning" id="modal-btn-start">Starten</button>
          <button type="button" class="btn btn-outline-secondary" id="modal-btn-stop">Stoppen</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabelKal" aria-hidden="true"
    id="mi-modal-kal">
    <div class="modal-dialog" data-keyboard="true">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="myModalLabelKal">Kalibrierung</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <p>Kalibrierung starten?</p>
          <p>Vorh. Daten werden überschrieben!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-warning" id="modal-btn-kal">Starten</button>
          <button type="button" class="btn btn-outline-secondary" id="modal-btn-abb">Abbruch</button>
        </div>
      </div>
    </div>
  </div>
  <script src="./jquery.min.js"></script>
  <script src="./bootstrap.min.js"></script>
  <script type="text/javascript">


    function refresh() {
      $.get("/reqMiscSet", function (data) {
        let miscRender = "<li class='list-group-item d-flex justify-content-between align-items-center'>Aktueller Modus";
        if (data.mode == 0) {
          miscRender += "<span class='badge badge-info'>";
        }
        else {
          miscRender += "<span class='badge badge-success'>";
        }
        if (data.mode == 0) {
          miscRender += "Aus";
          miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert Druck<span class='badge badge-info'>";
          miscRender += data.pressure.toFixed(2) + " bar";
          miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert CO2 Gehalt<span class='badge badge-info'>";
          miscRender += data.carbonation.toFixed(2) + " gr/l";
          miscRender += "</span></li>";
        }
        else if (data.mode == 1) {
          if (data.einheit < 2 && data.restverz != "0") {
            miscRender += "Spundomat " + data.restverz;
          }
          else {
            miscRender += "Spundomat";
          }
          miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert CO2 Gehalt<span class='badge badge-info'>";
          miscRender += data.carbonation.toFixed(2) + " gr/l";
          miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Verzögerung Karbonisierung<span class='badge badge-info'>";
          miscRender += data.delayspund;
          if (data.einheit == 0) {
            miscRender += " min";
          }
          else if (data.einheit == 1) {
            miscRender += " h";
          }
          else {
            miscRender += " gr/l";
          }
          miscRender += "</span></li>";
        }
        else if (data.mode == 2) {
          miscRender += "Spunden CO2-Gehalt";
          miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert CO2 Gehalt<span class='badge badge-info'>";
          miscRender += data.carbonation.toFixed(2) + " gr/l";
          miscRender += "</span></li>";
        }
        else if (data.mode == 3) {
          miscRender += "Spunden Druck";
          miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert Druck<span class='badge badge-info'>";
          miscRender += data.pressure.toFixed(2) + " bar";
          miscRender += "</span></li>";
        }
        else if (data.mode == 4) {
          miscRender += "Karbonisieren CO2-Gehalt";
          miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert CO2 Gehalt<span class='badge badge-info'>";
          miscRender += data.carbonation.toFixed(2) + " gr/l";
          miscRender += "</span></li>";
        }
        else if (data.mode == 5) {
          miscRender += "Karbonisieren Druck";
          miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert Druck<span class='badge badge-info'>";
          miscRender += data.pressure.toFixed(2) + " bar";
          miscRender += "</span></li>";
        }
        else if (data.mode == 9) {
          if (data.restverz != "0") {
            miscRender += "Überprüfe Dichtheit " + data.restverz;
          }
          else {
            miscRender += "Überprüfe Dichtheit";
          }
          miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert Druck<span class='badge badge-info'>";
          miscRender += data.pressure.toFixed(2) + " bar";
          miscRender += "</span></li>";
        }
        // else if (data.mode == 10) {
        //   miscRender += "Gärsteuerung ";
        //   miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zieltemperatur<span class='badge badge-info'>";
        //   miscRender += data.targettemp.toFixed(1) + " °C";
        //   miscRender += "</span></li>";
        // }
        // else if (data.mode == 11) {
        //   miscRender += "Gärsteuerung OG ";
        //   miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zieltemperatur<span class='badge badge-info'>";
        //   miscRender += data.targettemp.toFixed(1) + " °C";
        //   miscRender += "</span></li>";
        // }
        // else if (data.mode == 12) {
        //   miscRender += "Gärsteuerung UG ";
        //   miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zieltemperatur<span class='badge badge-info'>";
        //   miscRender += data.targettemp.toFixed(1) + " °C";
        //   miscRender += "</span></li>";
        // }
        else {
          miscRender += "Ablaufplan #" + data.ablauf;
          miscRender += "</span></li><li class='list-group-item d-flex justify-content-between align-items-center'>Zielwert Druck<span class='badge badge-info'>";
          miscRender += data.pressure.toFixed(2) + " bar";
          miscRender += "</span></li>";
        }
        miscRender += "<br/>";
        // if (data.mode >= 10 && data.mode <= 12) // Gärsteuerung
        // {
        // if (data.mode > 10) {
        //   miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'>Restzeit aktuelle Rampe";
        //   // <span class='badge badge-light'>";
        //   // miscRender += data.dauer;  
        //   // miscRender += "</span></li>";
        //   // miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'><span class='pull-right'>";
        //   miscRender += "<button class='btn btn-outline-warning' onclick='BtnRewind()' type='button'> << </button>";
        //   if (data.dauer == "Pause" || data.dauer == "Stopp")
        //   {
        //     miscRender += "<button class='btn btn-outline-success' onclick='BtnPause()' type='button'> |> </button>";
        //   }
        //   else
        //   {
        //     miscRender += "<button class='btn btn-outline-primary' onclick='BtnPause()' type='button'> || </button>";
        //   }
        //   miscRender += "<button class='btn btn-outline-warning' onclick='BtnForwind()' type='button'> >> </button>";
        //   miscRender += "<span class='badge badge-light'>";
        //   miscRender += data.dauer;
        //   miscRender += "</span></li>";
        // }
        // miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'>Aktuelle Temperatur<span class='badge badge-light'>";
        // if (data.temperatur == -127) {
        //   miscRender += "kein Temperatursensor angeschlossen";
        // }
        // else {
        //   miscRender += data.temperatur.toFixed(1) + " °C";
        // }
        // miscRender += "</span></li><br/>";
        // }
        // else {
        miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'> Aktueller Druck<span class='badge badge-light'>";
        if (data.druck == -1) {
          miscRender += "kein Drucksensor angeschlossen";
        }
        else {
          miscRender += data.druck.toFixed(2) + " bar";
        }
        miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'> Aktueller CO2 Gehalt<span class='badge badge-light'>";
        miscRender += data.co2.toFixed(2) + " gr/l";
        miscRender += "</span></li> <li class='list-group-item d-flex justify-content-between align-items-center'>Aktuelle Temperatur<span class='badge badge-light'>";
        if (data.temperatur == -127) {
          miscRender += "kein Temperatursensor angeschlossen";
        }
        else {
          miscRender += data.temperatur.toFixed(2) + " °C";
        }

        miscRender += "</span></li><br/>";
        // }
        if (data.offset == "0") {
          miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'>1. Kalibrierung bei 0 bar <span class='badge ";
          miscRender += " badge-danger'>Kalibrierung bei 0bar ausführen";
          miscRender += "</span></li>";
        }
        if (data.offset2 == "0") {
          miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'>2. Kalibrierung bei 2bar";
          miscRender += "<span class='badge >";
          miscRender += " badge-danger'>Kalibrierung bei 2bar ausführen";
          miscRender += "</span> </li> <br />";
        }
        miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'>Hardware<span class='badge ";
        if (data.gpio == 1) {
          miscRender += " badge-success'>Alarm aktiviert";
        }
        else if (data.gpio == 2) {
          miscRender += " badge-success'>Ventilator aktiviert";
        }
        else {
          miscRender += " badge-dark'>GPIO deaktiviert";
        }
        miscRender += "</span><span class='badge ";
        // if (data.co2sen) {
        //   if (data.wertco2 < 1000) {
        //     miscRender += " badge-success'>";
        //   }
        //   else if (data.wertco2 < 2000) {
        //     miscRender += " badge-warning'>";
        //   }
        //   else {
        //     miscRender += " badge-danger'>";
        //   }
        //   miscRender += "CO2: " + data.wertco2 + "ppm"
        // }
        // else {
        //   miscRender += " badge-dark'>CO2 Sensor deaktiviert";
        // }
        //miscRender += "</span><span class='badge ";
        if (data.mode < 10) {
          if (data.mv1) {
            miscRender += " badge-success'>MV1: " + data.mv1opendisp + " / " + data.mv1closedisp;
          }
          else {
            miscRender += " badge-dark'>MV1 deaktiviert";
          }
          miscRender += "</span><span class='badge ";
          if (data.mv2) {
            miscRender += " badge-success'>MV2: " + data.mv2opendisp + " / " + data.mv2closedisp;
          }
          else {
            miscRender += " badge-dark'>MV2 deaktiviert";
          }

        }
        // else if (data.mode >= 10) {
        //   if (data.controller == 1) {
        //     miscRender += " badge-success'>Kühlung aktiv";
        //   }
        //   else {
        //     miscRender += " badge-dark'>Kühlung aus";
        //   }
        //   miscRender += "</span><span class='badge ";
        //   if (data.controller == 2) {
        //     miscRender += " badge-success'>Heizung aktiv";
        //   }
        //   else {
        //     miscRender += " badge-dark'>Heizung aus";
        //   }
        // }
        miscRender += "</span> </li>";
        miscRender += "<li class='list-group-item d-flex justify-content-between align-items-center'>Dienste<span class='badge ";
        if (data.dichtheit == -127.0) {
          miscRender += " badge-dark'>Dichtheit nicht überprüft";
        }
        else {
          miscRender += " badge-secondary'>Dichtheit überprüft: " + data.dichtheit;
        }
        miscRender += "</span><span class='badge ";
        if (data.mdns) {
          miscRender += " badge-success align-items-'>http://" + data.mdns_name;
        }
        else {
          miscRender += " badge-dark'>mDNS deaktiviert";
        }
        miscRender += "</span><span class='badge ";
        if (data.startdb) {
          if (data.startvis) {
            if (data.visstate == 0) {
              miscRender += " badge-success'>Visualisierung: " + data.vistag;
            }
            else {
              miscRender += " badge-danger'>Visualisierung: " + data.visstate;
            }
          }
          else {
            if (data.visstate == 0) {
              miscRender += " badge-secondary'>Visualisierung pausiert";
            }
            else {
              miscRender += " badge-danger'>Visualisierung: " + data.visstate;
            }
          }
        }
        else {
          miscRender += " badge-dark'>Visualisierung deaktiviert";
        }
        miscRender += "</span></li>";
        $('#miscSettings').html(miscRender);

        if (data.alertstate) {
          alert("*** SYSINFO: WebUpdate abgeschlossen");
          location.reload();
        }
      });
    }

    var modalConfirmVis = function (callback) {
      $("#btn_visual").on("click", function () {
        var vistag;
        $.ajax({
          url: '/reqMisc?req=vistag',
          type: 'get',
          dataType: 'html',
          // async: false,
          cache: false,
          success: function (data) {
            vistag = data;
          }
        });
        $("#mi-modal-vis").modal('show');
        $('#modal_misc_vis_tag').val(vistag);
      });

      $("#modal-btn-start").on("click", function () {
        callback(true);
        $("#mi-modal-vis").modal('hide');
      });

      $("#modal-btn-stop").on("click", function () {
        callback(false);
        $("#mi-modal-vis").modal('hide');
      });
    };

    $('#mi-modal-vis').on('show', function (event) {

      var vistag;
      $.ajax({
        url: '/reqMisc?req=vistag',
        type: 'get',
        dataType: 'html',
        // async: false,
        cache: false,
        success: function (data) {
          vistag = data;
        }
      });
      modal.find('#modal_misc_vis_tag').val(vistag);
    });

    modalConfirmVis(function (confirm) {
      if (confirm) {
        // start
        var vistag = $('#modal_misc_vis_tag').val()
        $.ajax({
          url: '/visualisieren?vistag=' + vistag + '&startvis=1',
          type: 'POST',
          // async: false,
          cache: false
        }).done(function (msg) {
          window.location.reload(true);
        });
      }
      else {
        // stop
        var vistag = $('#modal_misc_vis_tag').val()
        $.ajax({
          url: '/visualisieren?vistag=' + vistag + '&startvis=0',
          type: 'POST',
          // async: false,
          cache: false
        }).done(function (msg) {
          window.location.reload(true);
        });
      }
    });

    var modalConfirmKal = function (callback) {
      $("#btn_kalibrieren").on("click", function () {
        $("#mi-modal-kal").modal('show');
      });

      $("#modal-btn-kal").on("click", function () {
        callback("1");
        $("#mi-modal-kal").modal('hide');
      });
      $("#modal-btn-abb").on("click", function () {
        callback("0");
        $("#mi-modal-kal").modal('hide');
      });
    };

    modalConfirmKal(function (confirm) {
      if (confirm == "1") {
        // start
        $.ajax({
          url: '/kalibrieren',
          type: 'POST',
          // async: false,
          cache: false
        }).done(function (msg) {
          window.location.reload(true);
        });
      }
    });

    var modalConfirmUpd = function (callback) {
      $("#btn_update").on("click", function () {
        $("#mi-modal-upd").modal('show');
      });

      $("#modal-btn-web").on("click", function () {
        document.getElementById("firmware").innerHTML = "WebUpdate gestartet ...";
        $("#mi-modal-upd").modal('hide');
        onload = setInterval(refresh, 120000);
        callback("1");
      });

      $("#modal-btn-file").on("click", function () {
        $("#mi-modal-upd").modal('hide');
        callback("2");
      });

      $("#modal-btn-abbruch").on("click", function () {
        callback("0");
        $("#mi-modal-upd").modal('hide');
      });
    };

    modalConfirmUpd(function (confirm) {
      if (confirm == "1") {
        $.ajax({
          url: '/startHTTPUpdate',
          type: 'POST',
          // async: false,
          cache: false
        }).done(function (msg) {
          window.location.reload(true);
        });;
      }
      else if (confirm == "2") {
        location.href = "/update";
      }
    });

    $('#misc_modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      $('#modal_misc_modus').load('/reqMode');
      $('#modal_misc_kombi_auswahl').load('/reqEinheit');
      $('#modal_misc_modus_gpio').load('/reqGPIO');
      var modal = $(this);
      modal.find('#modal_misc_reset').prop("checked", false);
      modal.find('#modal_misc_clear').prop("checked", false);
      modal.find('#modal_misc_eeprom').prop("checked", false);
      $.get("/reqMisc", function (data) {
        modal.find('#modal_misc_mdns_name').val(data.mdns_name);
        modal.find('#modal_misc_mdns').prop("checked", Boolean(Number(data.mdns)));
        modal.find('#modal_misc_mv1').prop("checked", Boolean(Number(data.mv1)));
        modal.find('#modal_misc_mv2').prop("checked", Boolean(Number(data.mv2)));
        modal.find('#modal_misc_testmode').prop("checked", Boolean(Number(data.testmode)));
        modal.find('#modal_misc_db_enable').prop("checked", Boolean(Number(data.startdb)));
        // modal.find('#modal_misc_co2sen').prop("checked", Boolean(Number(data.co2sen)));
        modal.find('#modal_misc_pressure').val(parseFloat(data.pressure).toFixed(2));
        modal.find('#modal_misc_carbonation').val(parseFloat(data.carbonation).toFixed(2));
        modal.find('#modal_misc_mv1open').val(data.mv1open);
        modal.find('#modal_misc_mv1close').val(data.mv1close);
        modal.find('#modal_misc_mv2open').val(data.mv2open);
        modal.find('#modal_misc_mv2close').val(data.mv2close);
        modal.find('#modal_misc_interval_pressure').val(data.uppressure);
        modal.find('#modal_misc_interval_temp').val(data.uptemp);
        modal.find('#modal_misc_kombi').val(data.verzkombi);
        modal.find('#modal_misc_offset').val(data.offset);
        modal.find('#modal_misc_offset2').val(data.offset2);
        modal.find('#modal_misc_db_server').val(data.dbserver);
        modal.find('#modal_misc_db_database').val(data.dbdatabase);
        modal.find('#modal_misc_db_user').val(data.dbuser);
        modal.find('#modal_misc_db_pass').val(data.dbpass);
        modal.find('#modal_misc_db_up').val(data.dbup);
        modal.find('#modal_misc_rssi').val(data.rssi);
        // modal.find('#modal_misc_interval_target').val(data.uptarget);
        // modal.find('#modal_misc_interval_con').val(data.upcon);
        // modal.find('#modal_misc_con').val(data.targettemp);
        modal.find('#modal_misc_vis_tag').val(data.vistag);
      });
    });

    $("#modal_misc_btn_save").click(function () {
      var modal = $('#misc_modal');
      var mdns_name = modal.find('#modal_misc_mdns_name').val();
      var pressure = modal.find('#modal_misc_pressure').val();
      var carbonation = modal.find('#modal_misc_carbonation').val();
      // var mode = $('#modal_misc_modus option:selected').text();
      var mode = $('#modal_misc_modus').val();
      var einheit = $('#modal_misc_kombi_auswahl').val();
      var gpio = $('#modal_misc_modus_gpio').val();
      var delayspund = modal.find('#modal_misc_kombi').val();
      var mv1open = modal.find('#modal_misc_mv1open').val();
      var mv1close = modal.find('#modal_misc_mv1close').val();
      var mv2open = modal.find('#modal_misc_mv2open').val();
      var mv2close = modal.find('#modal_misc_mv2close').val();
      var uppressure = modal.find('#modal_misc_interval_pressure').val();
      var uptemp = modal.find('#modal_misc_interval_temp').val();
      var dbserver = modal.find('#modal_misc_db_server').val();
      var dbdatabase = modal.find('#modal_misc_db_database').val();
      var dbuser = modal.find('#modal_misc_db_user').val();
      var dbpass = modal.find('#modal_misc_db_pass').val();
      var dbup = modal.find('#modal_misc_db_up').val();
      // var targettemp = modal.find('#modal_misc_con').val();
      // var uptarget = modal.find('#modal_misc_interval_target').val();
      // var upcon = modal.find('#modal_misc_interval_con').val();
      var mdns = modal.find('#modal_misc_mdns').prop("checked");
      var eeprom = modal.find('#modal_misc_eeprom').prop("checked");
      var reset = modal.find('#modal_misc_reset').prop("checked");
      var clear = modal.find('#modal_misc_clear').prop("checked");
      var mv1 = modal.find('#modal_misc_mv1').prop("checked");
      var mv2 = modal.find('#modal_misc_mv2').prop("checked");
      var testmode = modal.find('#modal_misc_testmode').prop("checked");
      var startdb = modal.find('#modal_misc_db_enable').prop("checked");
      // var co2sen = modal.find('#modal_misc_co2sen').prop("checked");
      $.ajax({
        url: '/setMisc?reset=' + reset + '&clear=' + clear + '&eeprom=' + eeprom + '&mdns=' + mdns + '&mdns_name=' + mdns_name + '&pressure=' + pressure + '&carbonation=' + carbonation + '&mode=' + mode + '&verzkombi=' + delayspund + '&einheit=' + einheit + '&mv1=' + mv1 + '&mv1open=' + mv1open + '&mv1close=' + mv1close + '&mv2=' + mv2 + '&mv2open=' + mv2open + '&mv2close=' + mv2close + '&uppressure=' + uppressure + '&uptemp=' + uptemp + '&testmode=' + testmode + '&startdb=' + startdb + '&dbserver=' + dbserver + '&dbdatabase=' + dbdatabase + '&dbuser=' + dbuser + '&dbpass=' + dbpass + '&dbup=' + dbup + '&gpio=' + gpio, // + '&co2sen=' + co2sen + '&targettemp=' + targettemp + '&uptarget=' + uptarget + '&upcon=' + upcon,
        type: 'POST',
        dataType: 'html',
        // async: false,
        cache: false
      });
      modal.modal('hide')
    });

    // function BtnRewind() {
    //   $.ajax({
    //     url: '/BtnRew',
    //     type: 'POST',
    //     async: true,
    //     cache: false
    //   });
    // };

    // function BtnPause() {
    //   //$(this).toggleClass('btn-outline-primary').toggleClass('btn-outline-danger');
    //   // var status = false;
    //   // if ($(this).is('.btn-success')) {
    //   //   status = true;
    //   // }
    //   $.ajax({
    //     url: '/BtnPause',
    //     type: 'POST',
    //     async: true,
    //     cache: false
    //   });
    // };

    // function BtnForwind() {
    //   $.ajax({
    //     url: '/BtnFor',
    //     type: 'POST',
    //     async: true,
    //     cache: false
    //   });
    // };

    $("#btn_reboot").click(function () {
      $.ajax({
        url: '/reboot',
        type: 'POST',
        // async: false,
        cache: false
      }).done(function (msg) {
        window.location.reload(true);
      });;
    });

    $(function () {
      $.get("/reqFirm?req=firmware", function (data) {
        document.getElementById("firmware").innerHTML = data;
      });
    });

  </script>
</body>

</html>